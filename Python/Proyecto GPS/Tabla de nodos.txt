-- Tabla de nodos
CREATE TABLE IF NOT EXISTS nodos (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL UNIQUE,
    latitude REAL,
    longitude REAL
);

-- Tabla de aristas
CREATE TABLE IF NOT EXISTS artistas (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    from_node_id INTEGER NOT NULL,
    to_node_id INTEGER NOT NULL,
    distance_km REAL NOT NULL CHECK(distance_km >= 0),
    time_min REAL NOT NULL CHECK(time_min >= 0),
    is_one_way BOOLEAN NOT NULL DEFAULT 1,
    has_toll BOOLEAN DEFAULT 0,
    is_blocked BOOLEAN DEFAULT 0,
    FOREIGN KEY (from_node_id) REFERENCES nodos(id),
    FOREIGN KEY (to_node_id) REFERENCES nodos(id),
    UNIQUE(from_node_id, to_node_id)
);

--Tabla de pesos
CREATE TABLE IF NOT EXISTS pesos(
id  INTEGER PRIMARY KEY AUTOINCREMENT,
artista_id INTEGER NOT NULL,
coste DECIMAL NOT NULL);

--Tabla de usuarios
CREATE TABLE IF NOT EXISTS usuarios(
id INTEGER PRIMARY KEY AUTOINCREMENT,
username VARCHAR (100) NOT NULL,
pass_haseada VARCHAR (400) NOT NULL);

-- Tabla de historial de rutas
CREATE TABLE IF NOT EXISTS historial_rutas (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    origin_id INTEGER NOT NULL,
    destination_id INTEGER NOT NULL,
    total_cost REAL NOT NULL,
    route_path TEXT NOT NULL,
    is_alternative BOOLEAN DEFAULT 0,
    calculation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    cost_type TEXT CHECK(cost_type IN ('distance', 'time')),
    FOREIGN KEY (origin_id) REFERENCES nodos(id),
    FOREIGN KEY (destination_id) REFERENCES nodos(id)
);

-- √çndices para mejorar rendimiento
CREATE INDEX IF NOT EXISTS idx_artistas_from ON artistas(from_node_id);
CREATE INDEX IF NOT EXISTS idx_edges_to ON edges(to_node_id);
CREATE INDEX IF NOT EXISTS idx_history_route ON route_history(origin_id, destination_id, cost_type);